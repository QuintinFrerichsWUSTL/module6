<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body {
            background-color: orange;
        }

        .row {
            margin-top: 30px;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script>
        var username = null;
        var currentRoom = null;
        var socketio = io.connect();
        /*
        Structure for room
             var room = {
             name: name,
             private: isPrivate,
             users: [],
             kicked: [],
             banned: [],
             messages: [],
             creator: name
         };

         Structure for message:
         var message = {
            messageText
            sender
         }
         */
        var rooms = [];

        function hideAll() {
            $('.container').children('div').each(function() {
                $(this).hide();
            });
        }

        function showLoginItems() {
            hideAll();
            $('#login').show();
        }

        function showMenuItems() {
            hideAll();
            $('.row').show();
        }

        function showMessagingItems() {
            hideAll();
            $('#messaging-center').show();
        }

        function createRoomButton(roomName) {
            var button = $('<button></button>')
                .text(roomName)
                .addClass('btn')
                .addClass('btn-primary')
                .addClass('room-btn');
            $('#rooms-list').append(button);
            button.click(function () {
                enterRoom(roomName);
            });
        }

        /* Sockets */

        socketio.on("message_to_client", function (data) {
            // Add the new message to the room
            rooms = data.rooms;
            // If we're in the room, show the message
            if (currentRoom !== null && data.roomName === currentRoom.name) {
                renderMessage(data.message);
            }
        });

        socketio.on('enter_room_client', function(data) {
            // Add the new user to the room
            rooms = data.rooms;
            console.log('Enter room', data);
            // If we just entered the room, render it
            if (data.newUser === username) {
                currentRoom = data.rooms.filter(function(room) {
                    return room.name === data.roomName
                })[0];
                showMessagingItems();
                loadMessages(); // Load and render messages
                loadUsers(); // Load and render users
                $('#leaveRoom').click(function () {
                    leaveRoom();
                });
            } else if (currentRoom !== null && data.roomName === currentRoom.name) {
                // If we're in the room and someone else joined, render
                renderUsername(data.newUser);
            }
        });

        socketio.on('get_rooms_client', function(data) {
            rooms = data;
            $.each(rooms, function(index, item) {
                createRoomButton(item.name);
            });
        });

        socketio.on('new_room_client', function(room) {
            console.log('New room: ', room);
            createRoomButton(room.name);
        });

        socketio.on('leave_room_client', function(data) {
            // Update rooms
            rooms = data.rooms;
            // If we just exited
            if (data.exitingUser === username) {
                $("#chatlog").empty();
                $('#user-list').empty();
                showMenuItems();
            } else if (currentRoom !== null && data.roomName === currentRoom.name) {
                // If we're in the room, remove that user from user list
                $('#' + data.exitingUser).empty();
            }
        });

        function renderMessage(message) {
            document.getElementById("chatlog").appendChild(document.createElement("hr"));
            document.getElementById("chatlog").appendChild(document.createTextNode(message.sender + ': ' +
                message.messageText));
        }

        function renderUsername(name) {
            var userListItem = $('<li></li>').text(name).attr('id', username);
            $('#user-list').append(userListItem);
        }

        function loadUsers() {
            $.each(currentRoom.users, function(index, item) {
                renderUsername(item);
            })
        }

        function sendMessage(message, room) {
            socketio.emit("message_to_server", {
                message: {
                    messageText: message,
                    sender: username
                },
                room: room
            });
        }

        function login() {
            username = document.getElementById("loginUsername").value;
            if (username !== '') {
                loadRooms();
                showMenuItems();
            } else {
                alert('Must have a username!');
            }
        }

        function loadMessages() {
            $.each(currentRoom.messages, function(index, item) {
                renderMessage(item);
            });
        }

        function loadRooms() {
            socketio.emit('get_rooms_server');
        }

        function enterRoom(roomName) {
            var data = {
                roomName: roomName,
                newUser: username
            };
            socketio.emit('enter_room_server', data);
        }

        function leaveRoom() {
            var data = {
                room: currentRoom,
                exitingUser: username
            };
            socketio.emit("leave_room_server", data);
        }

        function createRoom(name, isPrivate) {
            $.each(rooms, function() {
                if ($(this).name === name) {
                    alert('Room with that name exists!');
                    return
                }
            });
            var room = {
                name: name,
                private: isPrivate,
                users: [],
                kicked: [],
                banned: [],
                messages: []
            };
            socketio.emit('new_room_server', room);
        }
    </script>
</head>
<body>
<div class="container">
    <div id="login" class="text-center">
        <label for="loginUsername">Login with a username:</label>
        <input type="text" id="loginUsername">
        <button class="btn btn-primary" id="loginButton">Login</button>
    </div>

    <div class="row">
        <div class="col">
            <h1 class="display-4">Create</h1>
            <hr>
            <div id="create-room">
                <label for="room-name">Name</label>
                <input type="text" id="room-name">
                <br>
                <label for=public-radio"">Public</label>
                <input type="radio" id="public-radio" name="public-private" value="public">
                <br>
                <label for="private-radio">Private</label>
                <input type="radio" id="private-radio" name="public-private" value="private">
                <br>
                <button class="btn btn-primary" id="create-room-btn">Create room</button>
            </div>
        </div>
        <div class="col">
            <div id="rooms-list">
                <h1 class="display-4 text-center">Available</h1>
            </div>
        </div>
    </div>

    <div id="messaging-center">
        <button class="btn btn-danger" id="leaveRoom">Leave this room!</button>
        <label for="message_input">Your message: </label>
        <input type=text" id="message_input"/>
        <button class="btn btn-primary" id="sendMessageButton">send</button>
        <div id="user-list"></div>
        <div id="chatlog"></div>
    </div>
</div>

<script>
    showLoginItems();

    $('#loginButton').click(function () {
        login();
    });

    $('#sendMessageButton').click(function (e) {
        // Get value of input
        var message = e.target.parentNode.childNodes[5].value;
        sendMessage(message, currentRoom);
    });

    $('#create-room-btn').click(function () {
        var name = $('#room-name').val();
        var isPublic = document.getElementById('public-radio').checked;
        var isPrivate = document.getElementById('private-radio').checked;
        if (!isPrivate && !isPublic) {
            alert('Must select private or public!');
            return
        }
        createRoom(name, isPrivate);
    });
</script>
</body>
</html>